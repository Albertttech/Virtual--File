{% extends 'members/base.html' %}
{% block title %}VCF File Details{% endblock %}
{% block content %}
<div class="w-full max-w-4xl mx-auto mt-10 px-4">
  <h1 class="text-3xl font-bold neon mb-8 text-center">VCF File: {{ vcf.name }}</h1>
  <div class="bg-slate-900/80 rounded-xl shadow-lg p-8 relative">
    <div id="join-container" class="absolute top-6 right-8">
      <div class="flex items-center gap-2">
        <a href="#" id="upload-icon" class="p-2 rounded-full hover:bg-orange-100" title="Upload">
          <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 9l5-5 5 5M12 4v12" />
          </svg>
        </a>
        <a href="#" id="download-icon" class="p-2 rounded-full hover:bg-orange-100" title="Download">
          <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 11l5 5 5-5M12 4v12" />
          </svg>
        </a>
        {% if not joined %}
          <button id="join-btn" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition">Join</button>
        {% else %}
          <span class="inline-flex items-center px-6 py-2 border-2 border-green-300 bg-green-100/40 text-green-700 rounded-full font-semibold shadow select-none" style="cursor:default;">
            <span class="text-green-700 text-base">Active</span>
          </span>
        {% endif %}
      </div>
      <!-- Modal -->
      <div id="modal-overlay" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
        <div id="modal-content" class="bg-white rounded-xl shadow-xl p-8 w-full max-w-md mx-auto text-center relative">
          <button id="close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-red-400 text-2xl font-bold">&times;</button>
          <div id="modal-body" class="text-lg font-semibold text-slate-800">Modal Content</div>
        </div>
      </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Modal logic
  const modalOverlay = document.getElementById('modal-overlay');
  const modalBody = document.getElementById('modal-body');
  const closeModalBtn = document.getElementById('close-modal');
  function openModal(content) {
    modalBody.innerHTML = content;
    modalOverlay.classList.remove('hidden');
  }
  function closeModal() {
    modalOverlay.classList.add('hidden');
  }
  document.getElementById('upload-icon').addEventListener('click', function(e) {
    e.preventDefault();
    openModal('<span class="text-green-600 text-xl font-bold">Upload VCF File</span><br><br><input type="file" class="mt-4"><br><br><button class="mt-4 px-6 py-2 bg-green-500 text-white rounded-lg font-semibold">Upload</button>');
  });
  document.getElementById('download-icon').addEventListener('click', function(e) {
    e.preventDefault();
    openModal('<span class="text-blue-600 text-xl font-bold">Download VCF File</span><br><br><button class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg font-semibold">Download</button>');
  });
  closeModalBtn.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', function(e) {
    if (e.target === modalOverlay) closeModal();
  });
  const joinBtn = document.getElementById('join-btn');
  if (joinBtn) {
    joinBtn.addEventListener('click', function() {
      joinBtn.disabled = true;
      fetch('{% url "members:ajax_join_vcf" vcf.id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          document.getElementById('join-container').innerHTML = `<span class='inline-flex items-center gap-2 px-6 py-2 border-2 border-yellow-400 bg-yellow-100/20 text-yellow-700 rounded-full font-semibold shadow select-none' style='cursor:default;'><svg class='w-5 h-5 text-yellow-500' fill='none' stroke='currentColor' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7'/></svg><span class='text-yellow-700 text-base'>Active</span></span>`;
          // Add new contact row to table
          const tbody = document.getElementById('contacts-table-body');
          if (tbody && data.contact) {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-blue-900/40';
            tr.innerHTML = `<td class='px-4 py-2 font-medium text-white'>${data.contact.name}</td>` +
                          `<td class='px-4 py-2 text-blue-300'>${data.contact.phone}</td>` +
                          `<td class='px-4 py-2 text-blue-200'>${data.contact.email || ''}</td>`;
            // Remove 'No contacts' row if present
            const noContactsRow = tbody.querySelector('tr td[colspan]');
            if (noContactsRow) noContactsRow.parentElement.remove();
            tbody.appendChild(tr);
          }
        } else {
          alert(data.error || 'Join failed');
          joinBtn.disabled = false;
        }
      })
      .catch(() => {
        alert('Join failed');
        joinBtn.disabled = false;
      });
    });
  }
});
</script>
    <h2 class="text-lg font-semibold mb-4 text-blue-200">Contacts ({{ contacts|length }})</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-left text-sm text-blue-100">
        <thead>
          <tr class="bg-slate-800">
            <th class="px-4 py-2 font-semibold" style="width:30%">Name</th>
            <th class="px-4 py-2 font-semibold" style="width:20%">Number</th>
            <th class="px-4 py-2 font-semibold" style="width:50%">Email</th>
          </tr>
        </thead>
        <tbody id="contacts-table-body">
          {% for contact in contacts %}
          <tr class="border-b border-blue-900/40">
            <td class="px-4 py-2 font-medium text-white">{{ contact.name }}</td>
            <td class="px-4 py-2 text-blue-300">{{ contact.phone }}</td>
            <td class="px-4 py-2 text-blue-200">{{ contact.email|default:'' }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="3" class="text-center text-blue-400 py-8">No contacts found in this file.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
