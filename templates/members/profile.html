{% extends "members/base.html" %}
{% load static %}
{% block breadcrumb_page %}Profile{% endblock %}
{% block breadcrumb_page2 %}Profile{% endblock %}
{% block content %}
<div class="flex flex-wrap -mx-3">
  <div class="w-full max-w-full px-3 shrink-0 md:w-8/12 md:flex-0">
    <div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">

      <!-- Progress bar at top inside card -->
      <div id="progress-bar" 
           class="absolute top-0 left-0 h-1 bg-blue-500 rounded-t-2xl" 
           style="width: 0%; transition: width 0.3s ease;">
      </div>

      <div class="border-black/12.5 border-b-0 border-solid p-6 pb-0 rounded-t-2xl">
        <div class="flex items-center">
          <p class="mb-0 dark:text-white/80">Edit Profile</p>
          <button id="editProfileBtn" type="button" 
            class="inline-block px-8 py-2 mb-4 ml-auto font-bold leading-normal text-center text-white align-middle transition-all ease-in bg-blue-500 border-0 rounded-lg shadow-md cursor-pointer text-xs tracking-tight-rem hover:shadow-xs hover:-translate-y-px active:opacity-85">
            Edit
          </button>
        </div>
      </div>

      <div class="flex-auto p-6">
        <p class="leading-normal uppercase dark:text-white dark:opacity-60 text-sm">User Information</p>
        <div class="flex flex-wrap -mx-3">
          <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
            <div class="mb-4">
              <label for="username" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Username</label>
              <input type="text" name="username" value="{{ request.user.phone_number|default:'' }}" readonly style="background:#f1f5f9; cursor:not-allowed;" class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm leading-5.6 ease block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none" />
            </div>
          </div>
          <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
            <div class="mb-4">
              <label for="email" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Email address</label>
              <input type="email" name="email" value="{{ email|default:'' }}" readonly class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm block w-full rounded-lg border border-solid border-gray-300 bg-white px-3 py-2" />
            </div>
          </div>
          <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
            <div class="mb-4">
              <label for="first_name" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">First name</label>
              <input type="text" name="first_name" value="{{ request.user.profile.first_name|default:'' }}" readonly class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm block w-full rounded-lg border border-solid border-gray-300 bg-white px-3 py-2" />
            </div>
          </div>
          <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
            <div class="mb-4">
              <label for="last_name" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Last name</label>
              <input type="text"  name="last_name" value="{{ request.user.profile.last_name|default:'' }}"  readonly class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm block w-full rounded-lg border border-solid border-gray-300 bg-white px-3 py-2" />
            </div>
          </div>
        </div>
        <hr class="h-px mx-0 my-4 opacity-25 bg-gradient-to-r from-transparent via-black/40 to-transparent dark:via-white" />

        <p class="leading-normal uppercase dark:text-white dark:opacity-60 text-sm">Contact Information</p>
        <div class="flex flex-wrap -mx-3">
          <div class="w-full max-w-full px-3 shrink-0 md:w-full md:flex-0">
            <div class="mb-4">
              <label for="address" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Address</label>
              <input type="text" name="address" value="{{ request.user.profile.address|default:'' }}" readonly class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm block w-full rounded-lg border border-solid border-gray-300 bg-white px-3 py-2" />
            </div>
          </div>
          <div class="w-full max-w-full px-3 shrink-0 md:w-4/12 md:flex-0">
            <div class="mb-4">
              <label for="city" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">City</label>
              <input type="text" name="city" value="{{ request.user.profile.city|default:'' }}" readonly class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm block w-full rounded-lg border border-solid border-gray-300 bg-white px-3 py-2" />
            </div>
          </div>
          <div class="w-full max-w-full px-3 shrink-0 md:w-4/12 md:flex-0">
            <div class="mb-4">
              <label for="country" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Country</label>
              <input type="text" name="country" value="{{ country_name|default:'' }}" readonly style="background:#f1f5f9; cursor:not-allowed;" class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm leading-5.6 ease block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none" />
            </div>
          </div>
          <div class="w-full max-w-full px-3 shrink-0 md:w-4/12 md:flex-0">
            <div class="mb-4">
              <label for="postal_code" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">Postal code</label>
              <input type="text" name="postal_code" value="{{ request.user.profile.postal_code|default:'' }}" readonly class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm block w-full rounded-lg border border-solid border-gray-300 bg-white px-3 py-2" />
            </div>
          </div>
        </div>
        <hr class="h-px mx-0 my-4 opacity-25 bg-gradient-to-r from-transparent via-black/40 to-transparent dark:via-white" />

        <p class="leading-normal uppercase dark:text-white dark:opacity-60 text-sm">About me</p>
        <div class="flex flex-wrap -mx-3">
          <div class="w-full max-w-full px-3 shrink-0 md:w-full md:flex-0">
            <div class="mb-4">
              <label for="about_me" class="inline-block mb-2 ml-1 font-bold text-xs text-slate-700 dark:text-white/80">About me</label>
              <input type="text" name="about_me" value="{{ request.user.profile.about_me|default:'' }}" readonly class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm block w-full rounded-lg border border-solid border-gray-300 bg-white px-3 py-2" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right-side card remains unchanged -->
    <div class="w-full max-w-full px-3 mt-6 shrink-0 md:w-4/12 md:flex-0 md:mt-0">
      <div class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
        <img class="w-full rounded-t-2xl" src="{% static 'assets/img/bg-profile.jpg' %}" alt="profile cover image">
        <div class="flex flex-wrap justify-center -mx-3">
          <div class="w-4/12 max-w-full px-3 flex-0">
            <div class="mb-6 -mt-6 lg:mb-0 lg:-mt-16">
              <a href="javascript:;">
                <img class="h-auto max-w-full border-2 border-white rounded-circle" src="{% static 'assets/img/team-2.jpg' %}" alt="profile image">
              </a>
            </div>
          </div>
        </div>
        <div class="border-black/12.5 p-6 text-center pt-0 pb-6 lg:pt-2 lg:pb-4">
          <div class="flex justify-between">
            <button type="button" class="hidden px-8 py-2 font-bold text-white bg-cyan-500 lg:block text-xs rounded-lg shadow-md">Connect</button>
            <button type="button" class="block px-8 py-2 font-bold text-white bg-cyan-500 lg:hidden text-xs rounded-lg shadow-md">
              <i class="ni ni-collection text-2.8"></i>
            </button>
            <button type="button" class="hidden px-8 py-2 font-bold text-white bg-slate-700 lg:block text-xs rounded-lg shadow-md">Message</button>
            <button type="button" class="block px-8 py-2 font-bold text-white bg-slate-700 lg:hidden text-xs rounded-lg shadow-md">
              <i class="ni ni-email-83 text-2.8"></i>
            </button>
          </div>
        </div>
        <div class="flex-auto p-6 pt-0">
          <div class="flex justify-center space-x-6">
            <div class="text-center">
              <span class="font-bold text-lg dark:text-white">22</span>
              <span class="block text-sm opacity-80 dark:text-white">Friends</span>
            </div>
            <div class="text-center">
              <span class="font-bold text-lg dark:text-white">10</span>
              <span class="block text-sm opacity-80 dark:text-white">Photos</span>
            </div>
            <div class="text-center">
              <span class="font-bold text-lg dark:text-white">89</span>
              <span class="block text-sm opacity-80 dark:text-white">Comments</span>
            </div>
          </div>
          <div class="mt-6 text-center">
            <h5 class="dark:text-white">{{ request.user.profile.first_name|default:'first_name' }} {{ request.user.profile.last_name|default:'last_name' }}<span class="font-light">, 35</span></h5>
            <div class="mb-2 font-semibold text-base dark:text-white/80">
              <i class="mr-2 ni ni-pin-3"></i>Bucharest, {{ country_name|default:'' }}
            </div>
            <div class="mt-6 mb-2 font-semibold text-base dark:text-white/80">
              <i class="mr-2 ni ni-briefcase-24"></i>Solution Manager - Creative Tim Officer
            </div>
            <div class="dark:text-white/80">
              <i class="mr-2 ni ni-hat-3"></i>University of Computer Science
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<script src="{% static 'assets/js/plugins/perfect-scrollbar.min.js' %}" async></script>
<script src="{% static 'assets/js/argon-dashboard-tailwind.js?v=1.0.1' %}" async></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const editBtn = document.getElementById('editProfileBtn');
  const inputs = document.querySelectorAll('.flex-auto input');
  const progressBar = document.getElementById('progress-bar');
  let editing = false;
  let originalValues = {};

  // Store original values when entering edit mode
  function storeOriginalValues() {
    originalValues = {};
    inputs.forEach(input => {
      if (!input.readOnly && input.name !== 'country' && input.name !== 'username') {
        // Handle checkbox differently
        if (input.type === 'checkbox') {
          originalValues[input.name] = input.checked;
        } else {
          originalValues[input.name] = input.value;
        }
      }
    });
  }

  // Check if any values have changed
  function hasChanges() {
    return Array.from(inputs).some(input => {
      if (input.readOnly || input.name === 'country' || input.name === 'username') {
        return false;
      }
      
      // Handle checkbox comparison
      if (input.type === 'checkbox') {
        return input.checked !== originalValues[input.name];
      }
      
      return input.value !== originalValues[input.name];
    });
  }

  // Update progress bar with animation
  function updateProgressBar(percentage, duration = 300) {
    progressBar.style.transition = `width ${duration}ms ease`;
    progressBar.style.width = `${percentage}%`;
  }

  editBtn.addEventListener('click', async function() {
    if (!editing) {
      // Enter edit mode
      editing = true;
      storeOriginalValues();
      inputs.forEach(input => {
        if (input.name !== 'country' && input.name !== 'username') {
          input.readOnly = false;
          input.classList.remove('bg-green');
          input.classList.add('bg-blue-50');
        }
      });
      editBtn.textContent = 'Save';
      editBtn.classList.remove('bg-blue-500');
      editBtn.classList.add('bg-green-500');
      updateProgressBar(0);
    } else {
      // Save changes
      if (!hasChanges()) {
        // No changes made, just exit edit mode
        exitEditMode();
        return;
      }

      // Disable button during save
      editBtn.disabled = true;
      editBtn.textContent = 'Saving...';
      updateProgressBar(30);

      try {
        // Collect data for AJAX request
        const data = {};
        inputs.forEach(input => {
          if (!input.readOnly && input.name !== 'country' && input.name !== 'username') {
            // Handle checkbox differently
            if (input.type === 'checkbox') {
              data[input.name] = input.checked;
            } else {
              data[input.name] = input.value;
            }
          }
        });

        // Add CSRF token
        data['csrfmiddlewaretoken'] = '{{ csrf_token }}';

        // Send AJAX request
        const response = await fetch("{% url 'members:ajax_update_profile' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to save profile');
        }

        if (result.success) {
          // Update progress bar to show success
          updateProgressBar(100);
          
          // Update original values with new ones
          storeOriginalValues();
          
          // Show success message
          showToast('Profile updated successfully', 'success');
          
          // Exit edit mode after a short delay
          setTimeout(exitEditMode, 500);
        } else {
          throw new Error(result.error || 'Failed to save profile');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error saving profile: ' + error.message, 'error');
        editBtn.disabled = false;
        editBtn.textContent = 'Save';
        updateProgressBar(0);
      }
    }
  });

  function exitEditMode() {
    editing = false;
    inputs.forEach(input => {
      input.readOnly = true;
      input.classList.remove('bg-blue-50');
      input.classList.add('bg-white');
    });
    editBtn.textContent = 'Edit';
    editBtn.classList.remove('bg-green-500');
    editBtn.classList.add('bg-blue-500');
    editBtn.disabled = false;
    updateProgressBar(0);
  }

  function showToast(message, type = 'success') {
    // Simple alert for now - you can replace with a prettier toast notification
    alert(message);
    
    /* Example for a better toast notification:
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg ${
      type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
    */
  }
});
</script>
{% endblock %}