{% extends 'members/base.html' %}
{% load static %}
{% block title %}Settings{% endblock %}
{% block content %}
<style>
  .tab-bar {
    background: linear-gradient(90deg, #232946 0%, #6dd5ed 100%);
    border-radius: 2rem;
    box-shadow: 0 4px 24px #6dd5ed33, 0 0 8px #e11d7433;
    padding: 0.5rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    max-width: 90%;
    margin-left: auto;
    margin-right: auto;
  }
  .tab-button {
    font-size: 1.1rem;
    font-weight: 600;
    padding: 0.75rem 2.5rem;
    border-radius: 2rem;
    background: rgba(30,41,59,0.85);
    color: #fff;
    border: none;
    box-shadow: 0 2px 8px #2193b033;
    transition: all 0.2s cubic-bezier(.4,2,.3,1);
    cursor: pointer;
    outline: none;
    letter-spacing: 0.02em;
  }
  .tab-button.active, .tab-button:focus {
    background: linear-gradient(90deg, #6dd5ed 0%, #e11d74 100%);
    color: #fff;
    box-shadow: 0 0 16px #6dd5edcc, 0 0 8px #e11d74cc;
    transform: scale(1.07);
  }
  .tab-button:not(.active):hover {
    background: #334155;
    color: #6dd5ed;
    box-shadow: 0 0 8px #6dd5ed77;
  }
  .tab-button span {
    display: block;
    line-height: 1.1;
  }
</style>
<div class="w-full mx-auto mt-10 px-4">
  <h1 class="text-3xl font-bold neon mb-8 text-center">Settings</h1>
  <!-- Profile Section -->
  <div class="bg-slate-900/80 rounded-xl shadow-lg p-8 mb-8">
    <h2 class="text-xl font-semibold mb-6 text-blue-300">Profile</h2>
    <div class="space-y-4">
      <form method="post" action="" autocomplete="off">
        {% csrf_token %}
        <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-4">
          <label for="profile_name" class="w-32 text-blue-200 font-medium">Profile Name:</label>
          <input type="text" id="profile_name_input" name="profile_name" value="{% if request.user.profile %}{{ request.user.profile.profile_name }}{% else %}{% endif %}" placeholder="Enter your name" class="flex-1 bg-slate-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" readonly />
          <button type="button" id="profile_name_btn" class="ml-2 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">Edit</button>
        </div>
        <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-4">
          <label for="name" class="w-32 text-blue-200 font-medium">Contact:</label>
          <input type="text" id="name" name="name" value="{{ request.user.get_full_name|default:request.user.username }}" class="flex-1 bg-slate-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" readonly />
        </div>
        <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-4">
          <label for="email" class="w-32 text-blue-200 font-medium">Email:</label>
          <input type="email" id="email_input" name="email" value="{% if request.user.profile and request.user.profile.email %}{{ request.user.profile.email }}{% else %}{{ request.user.email }}{% endif %}" class="flex-1 bg-slate-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" readonly />
          <button type="button" id="email_btn" class="ml-2 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">Edit</button>
        </div>
        <!-- AJAX Save/Edit logic will be handled by JavaScript below -->
      </form>
      <script>
        function toggleEdit(inputId, btnId, url, field) {
          const input = document.getElementById(inputId);
          const btn = document.getElementById(btnId);
          let editing = false;
          btn.addEventListener('click', function() {
            if (!editing) {
              input.readOnly = false;
              input.focus();
              btn.textContent = 'Save';
              editing = true;
            } else {
              // Save via AJAX
              const value = input.value;
              btn.disabled = true;
              fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ [field]: value })
              })
              .then(r => r.json())
              .then(data => {
                if (data.success) {
                  input.readOnly = true;
                  btn.textContent = 'Edit';
                  editing = false;
                } else {
                  alert(data.error || 'Save failed');
                }
              })
              .catch(() => alert('Save failed'))
              .finally(() => { btn.disabled = false; });
            }
          });
        }
        document.addEventListener('DOMContentLoaded', function() {
          toggleEdit('profile_name_input', 'profile_name_btn', '{% url "members:ajax_update_profile_name" %}', 'profile_name');
          toggleEdit('email_input', 'email_btn', '{% url "members:ajax_update_email" %}', 'email');
        });
      </script>
      </form>
      <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-2">
        <label class="w-32 text-blue-200 font-medium">Demo:</label>
        <span class="text-blue-400">Coming soon...</span>
      </div>
    </div>
  </div>
  <!-- File Setting Section -->
  <!-- Radio Section -->
  <div class="bg-slate-900/80 rounded-xl shadow-lg p-8 mb-8">
    <h2 class="text-xl font-semibold mb-6 text-blue-300">Box Options</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="flex items-center space-x-2 mb-4 md:mb-0">
        <input id="box1" name="box-group" type="checkbox" class="accent-blue-500 w-5 h-5 rounded border-2 border-blue-400 focus:ring-2 focus:ring-blue-400" />
        <label for="box1" class="text-blue-200">Demo 1</label>
      </div>
      <div class="flex items-center space-x-2 mb-4 md:mb-0">
        <input id="box2" name="box-group" type="checkbox" class="accent-blue-500 w-5 h-5 rounded border-2 border-blue-400 focus:ring-2 focus:ring-blue-400" />
        <label for="box2" class="text-blue-200">Demo 2</label>
      </div>
      <div class="flex items-center space-x-2 mb-4 md:mb-0">
        <input id="box3" name="box-group" type="checkbox" class="accent-blue-500 w-5 h-5 rounded border-2 border-blue-400 focus:ring-2 focus:ring-blue-400" />
        <label for="box3" class="text-blue-200">Demo 3</label>
      </div>
      <div class="flex items-center space-x-2">
        <input id="box4" name="box-group" type="checkbox" class="accent-blue-500 w-5 h-5 rounded border-2 border-blue-400 focus:ring-2 focus:ring-blue-400" {% if request.user.profile and request.user.profile.include_email_in_vcf %}checked{% endif %}/>
        <label for="box4" class="text-blue-200">Auto include my <br>email in all my New VCF</label>
      </div>
      <div class="flex items-center space-x-2">
        <input id="box5" name="box-group" type="checkbox" class="accent-blue-500 w-5 h-5 rounded border-2 border-blue-400 focus:ring-2 focus:ring-blue-400" />
        <label for="box5" class="text-blue-200">Email for New VCF File (when created)</label>
      </div>
      <div class="flex items-center space-x-2">
        <input id="box6" name="box-group" type="checkbox" class="accent-blue-500 w-5 h-5 rounded border-2 border-blue-400 focus:ring-2 focus:ring-blue-400" />
        <label for="box6" class="text-blue-200">Update me when my premium file are updated</label>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const box4 = document.getElementById('box4');
        box4.addEventListener('change', function() {
          fetch('{% url "members:ajax_update_include_email" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ include_email_in_vcf: box4.checked })
          })
          .then(r => r.json())
          .then(data => {
            if (!data.success) {
              alert(data.error || 'Could not update email preference');
            }
          })
          .catch(() => alert('Could not update email preference'));
        });
        // Demo 5: Email for Free & Premium VCF File (when created)
        const box5 = document.getElementById('box5');
        box5.addEventListener('change', function() {
          // TODO: Implement backend logic for demo 5
          // Example: fetch('/your-endpoint/', { method: 'POST', body: JSON.stringify({ email_for_creation: box5.checked }) })
        });
        // Demo 6: My Premium VCF Contact Update
        const box6 = document.getElementById('box6');
        box6.addEventListener('change', function() {
          // TODO: Implement backend logic for demo 6
          // Example: fetch('/your-endpoint/', { method: 'POST', body: JSON.stringify({ premium_contact_update: box6.checked }) })
        });
      });
                // Password edit/save logic
          const passwordInput = document.getElementById('password_input');
          const passwordBtn = document.getElementById('password_btn');
          let passwordEditing = false;
          passwordBtn.addEventListener('click', function() {
            if (!passwordEditing) {
              passwordInput.readOnly = false;
              passwordInput.focus();
              passwordBtn.textContent = 'Save';
              passwordEditing = true;
            } else {
              // Save via AJAX (implement backend logic as needed)
              const value = passwordInput.value;
              passwordBtn.disabled = true;
              fetch('/members/ajax/update-password/', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ password: value })
              })
              .then(r => r.json())
              .then(data => {
                if (data.success) {
                  passwordInput.readOnly = true;
                  passwordBtn.textContent = 'Edit';
                  passwordEditing = false;
                  passwordInput.value = '';
                  alert('Password updated!');
                } else {
                  alert(data.error || 'Save failed');
                }
              })
              .catch(() => alert('Save failed'))
              .finally(() => { passwordBtn.disabled = false; });
            }
          });
    </script>
  </div>
  <!-- File Setting Section -->
  <div class="bg-slate-900/80 rounded-xl shadow-lg p-8">
    <h2 class="text-xl font-semibold mb-6 text-blue-300">Account Settings</h2>
    
  <!-- Auth Email Section -->
<!-- Auth Email Section -->
<div class="bg-slate-900/80 rounded-xl shadow-lg p-8 mb-8">
  <h2 class="text-xl font-semibold mb-6 text-blue-300">Authentication Email</h2>
  <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-4">
    <label for="auth_email" class="w-32 text-blue-200 font-medium">Authentication Email:</label>
    <div class="flex-1 flex items-center gap-2">
      <input type="email" id="auth_email_input" name="auth_email" 
             value="{{ request.user.authentication_email|default:'' }}" 
             class="w-full bg-slate-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" 
             {% if request.user.authentication_email %}readonly{% endif %} />
      <div id="auth_email_buttons" class="flex gap-2">
        {% if not request.user.authentication_email %}
          <button type="button" class="auth-btn auth-authenticate px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
            Authenticate
          </button>
        {% else %}
          <button type="button" class="auth-btn auth-edit px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
            Edit
          </button>
        {% endif %}
      </div>
    </div>
  </div>
  <p id="auth_email_error" class="text-red-500 text-sm mt-2 hidden">Please enter a valid email address.</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const authEmailInput = document.getElementById('auth_email_input');
  const authEmailButtons = document.getElementById('auth_email_buttons');
  const authEmailError = document.getElementById('auth_email_error');
  const originalEmail = authEmailInput.value;

  // Use event delegation for all button clicks
  authEmailButtons.addEventListener('click', function(e) {
    if (e.target.classList.contains('auth-edit')) {
      handleEditClick();
    } 
    else if (e.target.classList.contains('auth-cancel')) {
      handleCancelClick();
    }
    else if (e.target.classList.contains('auth-authenticate')) {
      handleAuthenticateClick();
    }
  });

  function handleEditClick() {
    authEmailInput.readOnly = false;
    authEmailInput.focus();
    
    // Replace edit button with cancel and authenticate buttons
    authEmailButtons.innerHTML = `
      <button type="button" class="auth-btn auth-cancel px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 transition">
        Cancel
      </button>
      <button type="button" class="auth-btn auth-authenticate px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
        Authenticate
      </button>
    `;
  }

  function handleCancelClick() {
    authEmailInput.readOnly = true;
    authEmailInput.value = originalEmail;
    
    // Restore edit button
    authEmailButtons.innerHTML = `
      <button type="button" class="auth-btn auth-edit px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
        Edit
      </button>
    `;
  }

  function handleAuthenticateClick() {
    if (authEmailInput.checkValidity()) {
      const emailValue = authEmailInput.value;
      authEmailError.classList.add('hidden');
      window.location.href = `{% url 'members:auth_email' %}?email=${encodeURIComponent(emailValue)}`;
    } else {
      authEmailError.classList.remove('hidden');
    }
  }
});
</script>
    <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-4">
      <label for="reset_password_btn" class="w-32 text-blue-200 font-medium">Password Reset:</label>
      <button type="button" id="reset_password_btn" class="ml-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Reset Password</button>
    </div>
    <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-4">
      <label for="reset_password_btn" class="w-32 text-blue-200 font-medium">Account State:</label>
      <button type="button" id="reset_password_btn" class="ml-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Freeze my Account</button>
    </div>
    <!-- Password Reset Modal -->
    <div id="resetPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-slate-800 rounded-xl p-8 shadow-lg w-full max-w-md">
        <h3 class="text-lg font-bold text-blue-300 mb-4">Reset Password</h3>
        <p class="text-blue-200 mb-6">Are you sure you want to reset your password? You will receive an email with instructions.</p>
        <div class="flex justify-end gap-2">
          <button id="cancelResetBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Cancel</button>
          <button id="confirmResetBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Confirm</button>
        </div>
      </div>
    </div>
    <!-- Password Change Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-slate-800 rounded-xl p-8 shadow-lg w-full max-w-md">
        <h3 class="text-lg font-bold text-blue-300 mb-4">Change Password</h3>
        <form method="post" action="{% url 'members:member_settings' %}" id="changePasswordForm" autocomplete="off">
          {% csrf_token %}
          <div class="mb-4">
            <label for="old_password" class="block text-blue-200 mb-1">Current Password</label>
            <input type="password" id="old_password" name="old_password" class="w-full bg-slate-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
          </div>
          <div class="mb-4">
            <label for="new_password" class="block text-blue-200 mb-1">New Password</label>
            <input type="password" id="new_password" name="new_password" class="w-full bg-slate-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
          </div>
          <div class="mb-6">
            <label for="confirm_new_password" class="block text-blue-200 mb-1">Confirm New Password</label>
            <input type="password" id="confirm_new_password" name="confirm_new_password" class="w-full bg-slate-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" id="cancelChangeBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700" onclick="document.getElementById('changePasswordModal').classList.add('hidden');">Cancel</button>
            <button type="submit" id="updatePasswordBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update Password</button>
          </div>
          {% if password_error %}
            <div class="mt-4 text-red-400">{{ password_error }}</div>
          {% endif %}
          {% if password_success %}
            <div class="mt-4 text-green-400">{{ password_success }}</div>
          {% endif %}
        </form>
      </div>
    </div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const resetBtn = document.getElementById('reset_password_btn');
    const resetModal = document.getElementById('resetPasswordModal');
    const cancelResetBtn = document.getElementById('cancelResetBtn');
    const confirmResetBtn = document.getElementById('confirmResetBtn');
    const changeModal = document.getElementById('changePasswordModal');
    const cancelChangeBtn = document.getElementById('cancelChangeBtn');
    const changeForm = document.getElementById('changePasswordForm');

    if (resetBtn && resetModal && cancelResetBtn && confirmResetBtn && changeModal && cancelChangeBtn && changeForm) {
      resetBtn.addEventListener('click', function() {
        resetModal.classList.remove('hidden');
      });

      cancelResetBtn.addEventListener('click', function() {
        resetModal.classList.add('hidden');
      });

      confirmResetBtn.addEventListener('click', function() {
        resetModal.classList.add('hidden');
        changeModal.classList.remove('hidden');
      });

      resetModal.addEventListener('click', function(e) {
        if (e.target === resetModal) {
          resetModal.classList.add('hidden');
        }
      });

      cancelChangeBtn.addEventListener('click', function() {
        changeModal.classList.add('hidden');
      });

      changeModal.addEventListener('click', function(e) {
        if (e.target === changeModal) {
          changeModal.classList.add('hidden');
        }
      });

    changeForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const oldPassword = document.getElementById('old_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmNewPassword = document.getElementById('confirm_new_password').value;
    const updateBtn = document.getElementById('updatePasswordBtn');

    if (!oldPassword || !newPassword || !confirmNewPassword) {
        showToast('All fields are required.', false);
        return;
    }
    if (newPassword !== confirmNewPassword) {
        showToast('New passwords do not match.', false);
        return;
    }

    // Show loading state
    updateBtn.disabled = true;
    updateBtn.textContent = 'Updating...';

    fetch('{% url "members:ajax_change_password" %}', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
        old_password: oldPassword,
        new_password: newPassword
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.logout) {
        showToast('Password changed. Logging out...', true);
        setTimeout(() => {
            window.location.href = data.redirect_url || '/members/login/';
        }, 1500);
        } else if (data.success) {
        showToast('Password updated successfully!', true);
        changeModal.classList.add('hidden');
        } else {
        showToast(data.error || 'Password update failed.', false);
        }
    })
    .catch(() => {
        showToast('Password update failed.', false);
    })
    .finally(() => {
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update Password';
    });
    });


      function showToast(message, success) {
        let toast = document.getElementById('toastMsg');
        if (!toast) {
          toast = document.createElement('div');
          toast.id = 'toastMsg';
          toast.className = 'fixed top-6 right-6 z-[9999] px-6 py-3 rounded-lg shadow-lg text-white text-sm font-semibold transition-all duration-500';
          document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.style.background = success
          ? 'linear-gradient(90deg,#16a34a,#22d3ee)'
          : 'linear-gradient(90deg,#e11d74,#f43f5e)';
        toast.style.opacity = '1';
        toast.style.pointerEvents = 'auto';
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.pointerEvents = 'none';
        }, 3000);
      }
    }
  });
</script>

  </div>
</div>
<script src="{% static 'members/email_auth.js' %}"></script>
{% endblock %}
